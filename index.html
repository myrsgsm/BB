<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bill Book - Royal Sherwani</title>
    
    <script>
        if (!window.crypto || !window.crypto.subtle || !window.crypto.getRandomValues) {
            const fakeCrypto = {
                getRandomValues: function(array) {
                    for (let i = 0; i < array.length; i++) array[i] = Math.floor(Math.random() * 256);
                    return array;
                },
                subtle: {
                    digest: function(algo, data) { return Promise.resolve(new Uint8Array(32)); }
                }
            };
            try { Object.defineProperty(window, 'crypto', { value: fakeCrypto, writable: true }); } 
            catch(e) { window.crypto = fakeCrypto; }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEME --- */
        :root { --gold: #C5A059; --bg: #121212; --card: #1E1E1E; --text: #E0E0E0; --green: #4CAF50; --red: #FF5252; --blue: #2196F3; --orange: #FF9800; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body.app-mode { background-color: var(--bg); color: var(--text); font-family: 'Lato', sans-serif; margin: 0; padding: 0; overscroll-behavior-x: none; }

        /* DEBUG CONSOLE */
        #debug-console {
            background: #000; border: 1px solid #333; color: #0f0;
            font-family: monospace; font-size: 10px; padding: 10px;
            margin-top: 15px; width: 100%; height: 100px;
            overflow-y: auto; border-radius: 5px; text-align: left;
            display: block;
        }
        .log-err { color: #ff5555; font-weight: bold; border-bottom: 1px solid #550000; }
        .log-warn { color: #ffaa00; }
        .log-ok { color: #00ff00; }

        /* LOGIN SCREEN */
        #login-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .inp-login { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; margin-bottom: 10px; font-size: 16px; }
        .btn-act { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; cursor: pointer; color: #000; }
        
        /* APP CSS */
        .screen { display: none; padding: 10px; padding-bottom: 100px; }
        .active-screen { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .app-header { background: #000; padding: 15px; border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .app-brand { font-family: 'Cinzel', serif; color: var(--gold); font-size: 18px; letter-spacing: 1px; }
        .btn-icon { background: #333; border: 1px solid #444; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-header-text { background: #333; border: 1px solid var(--gold); color: var(--gold); font-size: 11px; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        /* MODAL FIX: Z-index set to 3000 to overlay login screen */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; align-items: center; justify-content: center; flex-direction: column; }
        .modal-card { background: var(--card); padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid var(--gold); position: relative; }

        .status-badge-header { padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: 900; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.2); margin-left: 10px; transition: all 0.3s ease; }
        .status-badge-header.online { background: rgba(76, 175, 80, 0.2); border-color: var(--green); color: var(--green); box-shadow: 0 0 10px rgba(76, 175, 80, 0.3); }
        .status-badge-header.offline { background: rgba(255, 82, 82, 0.2); border-color: var(--red); color: var(--red); animation: pulse-red 1s infinite; }
        .status-badge-header .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; box-shadow: 0 0 5px currentColor; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 rgba(255, 82, 82, 0); } 50% { box-shadow: 0 0 15px rgba(255, 82, 82, 0.5); } 100% { box-shadow: 0 0 0 rgba(255, 82, 82, 0); } }
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; margin-bottom: 5px; scrollbar-width: none; }
        .filter-btn { background: #222; border: 1px solid #444; color: #888; padding: 8px 15px; border-radius: 20px; font-size: 11px; font-weight: bold; white-space: nowrap; cursor: pointer; }
        .filter-btn.active { background: var(--gold); color: black; border-color: var(--gold); }
        .book-tile { background: var(--card); border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--gold); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .bt-name { font-weight: 900; color: white; font-size: 16px; }
        .bt-stats { font-size: 11px; color: #888; text-align: right; }
        .search-bar { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        .bill-item { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #333; display: flex; justify-content: space-between; align-items: center; position: relative; cursor: pointer; }
        .st-red { border-left-color: var(--red); }
        .st-orange { border-left-color: var(--orange); } 
        .st-green { border-left-color: var(--green); }
        .st-dim { border-left-color: #666; opacity: 0.6; }
        .st-black { border-left-color: #000; opacity: 0.5; }
        .status-badge { position: absolute; top: 5px; right: 5px; font-size: 9px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: #000; color: #aaa; text-transform: uppercase; }
        .pkt-badge-inline { background: var(--gold); color: black; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px; font-weight: 900; display: inline-block; vertical-align: middle; }
        .del-time-badge { position: absolute; bottom: 5px; right: 5px; font-size: 9px; color: var(--gold); font-family: monospace; }
        .b-main { flex: 1; }
        .b-amt { text-align: right; }
        .dh-row { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .section-label { font-size: 11px; color: #888; text-transform: uppercase; margin: 25px 0 8px 0; border-bottom: 1px solid #333; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .linked-container { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding: 10px; border: 1px dashed var(--blue); border-radius: 8px; background: rgba(33, 150, 243, 0.05); }
        .linked-header { color: var(--blue); font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .linked-item-row { background: rgba(33, 150, 243, 0.1); border: 1px solid var(--blue); padding: 8px; border-radius: 6px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .linked-id { font-family: monospace; color: var(--blue); font-weight: bold; font-size: 13px; }
        .linked-st-txt { font-weight: bold; color: white; font-size: 10px; }
        .media-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .media-btn { background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; font-size: 18px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .media-btn.recording { background: var(--red); border-color: var(--red); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .media-box { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; background: #000; border: 1px solid #333; cursor: pointer; }
        .media-thumb { width: 100%; height: 100%; object-fit: cover; }
        .btn-del-media { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.8); color: white; border: none; width: 20px; height: 20px; border-radius: 50%; font-size: 10px; cursor: pointer; z-index: 10; }
        .audio-player-ui { background: #252525; border-radius: 20px; padding: 10px; display: flex; align-items: center; gap: 10px; height: 100%; justify-content: center; }
        .play-btn { width: 30px; height: 30px; background: var(--green); border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-danger { background: var(--red); color: white; }
        .admin-menu { position: absolute; top: 60px; right: 15px; background: #222; border: 1px solid var(--gold); border-radius: 8px; display: none; z-index: 100; width: 160px; }
        .admin-opt { padding: 12px; border-bottom: 1px solid #333; font-size: 13px; font-weight: bold; cursor: pointer; }
        #upload-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 15px; }
        .progress-container { width: 250px; background: #333; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.3s ease; }
        .upload-text { color: var(--gold); font-weight: bold; font-family: 'Cinzel'; font-size: 18px; }
        .upload-details { color: #888; font-size: 12px; font-family: monospace; }
        .loader { border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .meas-capture-box { background: #1a1a1a; padding: 20px; border: 1px solid var(--gold); border-radius: 12px; color: white; }
        .meas-header-row { text-align: center; border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 15px; }
        .meas-bill-no { font-size: 24px; font-weight: 900; color: var(--gold); font-family: 'Cinzel'; }
        .meas-cols { display: flex; gap: 20px; }
        .meas-col { flex: 1; }
        .meas-col-title { color: var(--gold); font-weight: bold; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; }
        .meas-pair { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .meas-k { font-size: 12px; color: #aaa; font-weight: bold; }
        .meas-v { font-size: 14px; color: white; font-weight: 900; }
        #video-recorder-modal { background: black; z-index: 1600; }
        #camera-preview { width: 100%; max-height: 60vh; background: #000; border: 1px solid #333; }
        .rec-controls { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .rec-btn { width: 70px; height: 70px; border-radius: 50%; border: 4px solid white; background: var(--red); cursor: pointer; transition: all 0.3s; }
        .rec-btn.recording { animation: pulse-rec 1s infinite; border-color: var(--red); background: transparent; transform: scale(0.9); }
        @keyframes pulse-rec { 0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 82, 82, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); } }
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1500; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #lightbox-img { max-width: 100%; max-height: 80vh; object-fit: contain; }
        #lightbox-video { max-width: 100%; max-height: 80vh; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; background: none; border: none; cursor: pointer; }
        @media print { body.app-mode { display: none !important; } #print-area { display: block !important; } }
        #print-area { display: none; }
    </style>
</head>
<body class="app-mode">

    <div id="login-screen">
        <h2 style="color:var(--gold); font-family:'Cinzel'; margin-bottom:20px;">BILL BOOK</h2>
        <div style="width:280px;">
            <input type="email" id="email" class="inp-login" placeholder="Email">
            <input type="password" id="password" class="inp-login" placeholder="Password">
            <button class="btn-act" id="loginBtn" onclick="handleLogin()">LOGIN</button>
            <div id="login-loader" class="loader" style="margin:10px auto; display:none;"></div>
        </div>
        <div style="width:90%; max-width:300px;">
            <div id="debug-console">System Log...<br></div>
        </div>
        <button class="btn-icon" style="position:absolute; bottom:20px; right:20px; border-color:var(--gold); color:var(--gold);" onclick="requestKeyAccess()">
            <i class="fas fa-key"></i>
        </button>
    </div>

    <div id="app-container" style="display:none;">
        <div id="screen-home" class="screen active-screen">
            <div class="app-header">
                <div class="app-brand">BILL BOOKS</div>
                <div class="status-badge-header offline global-status">
                    <div class="dot"></div><span class="status-text">CONNECTING</span>
                </div>
                <div style="display:flex; gap:15px; margin-left:auto;">
                    <button class="btn-icon" onclick="createNewBookPrompt()">+</button>
                    <button class="btn-icon" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            <div id="books-loader" style="text-align:center; color:#666; margin-top:20px;">Loading...</div>
            <div id="books-container" style="margin-top:15px;"></div>
        </div>
        <div id="screen-list" class="screen">
            <div class="app-header">
                <button class="btn-icon" onclick="navigateBack()"><i class="fas fa-arrow-left"></i></button>
                <div class="app-brand" id="list-title" style="margin-left:10px;">BOOK</div>
                <div class="status-badge-header offline global-status">
                    <div class="dot"></div><span class="status-text">OFFLINE</span>
                </div>
                <div style="display:flex; gap:10px; margin-left:auto;">
                    <button class="btn-icon" onclick="promptStats()">üìä</button>
                    <button class="btn-icon" onclick="promptSettings()">‚öôÔ∏è</button>
                </div>
            </div>
            <input type="text" id="search-inp" class="search-bar" placeholder="Search Bill No / Name..." oninput="applyFilters()">
            <div class="filter-row">
                <button class="filter-btn active" onclick="setFilter('ALL', this)">All Bills</button>
                <button class="filter-btn" onclick="setFilter('NO_ACTION', this)">No Action</button>
                <button class="filter-btn" onclick="setFilter('READY', this)">Ready</button>
                <button class="filter-btn" onclick="setFilter('SOLD', this)">Sold</button>
                <button class="filter-btn" onclick="setFilter('CANCELLED', this)">Cancelled</button>
            </div>
            <div id="bills-container"></div>
        </div>

        <div id="screen-detail" class="screen">
            <div class="app-header">
                <button class="btn-icon" onclick="navigateBack()"><i class="fas fa-arrow-left"></i></button>
                <div class="status-badge-header offline global-status">
                    <div class="dot"></div><span class="status-text">OFFLINE</span>
                </div>
                <div style="display:flex; gap:10px; margin-left:auto;">
                    <button class="btn-header-text" onclick="showMeas()">üìè SIZE</button>
                    <button class="btn-icon" onclick="toggleAdmin()">‚ãÆ</button>
                </div>
                <div id="admin-menu" class="admin-menu">
                    <div class="admin-opt" onclick="adminAction('edit')">üì¶ EDIT ITEMS</div>
                    <div class="admin-opt" onclick="adminAction('amt')">‚úèÔ∏è EDIT AMOUNT</div>
                    <div class="admin-opt" style="color:var(--red);" onclick="adminAction('cancel')">üö´ CANCEL BILL</div>
                </div>
            </div>

            <div id="det-content" style="margin-top:15px;">
                <div class="dh-row">
                    <div>
                        <div style="font-size:24px; font-weight:900; color:var(--gold);" id="d-no">#--</div>
                        <div style="font-size:12px; color:#888;" id="d-date">--</div>
                    </div>
                    <div>
                        <div class="status-badge" id="d-status" style="position:static; padding:5px 10px; font-size:11px;">PENDING</div>
                        <div id="d-del-time" style="font-size:10px; color:var(--gold); margin-top:5px; text-align:right;"></div>
                    </div>
                </div>

                <div style="background:#222; padding:15px; border-radius:8px; border:1px solid #333;">
                    <div style="font-size:18px; font-weight:bold;" id="d-name">--</div>
                    <div style="font-size:14px; color:#aaa; margin-top:2px;" id="d-phone">--</div>
                    <div style="font-size:14px; color:var(--gold); margin-top:8px; font-weight:bold;">Delivery: <span id="d-del" style="color:white;">--</span></div>
                </div>

                <div id="linked-container" class="linked-container hidden">
                    <div class="linked-header">UNIQUE ID / FACTORY LINK</div>
                    <div id="linked-list"></div>
                </div>

                <div class="section-label">
                    <span>MEDIA / NOTES</span>
                    <span id="note-status" style="font-size:10px; color:var(--green); font-weight:bold;"></span>
                </div>
                <textarea id="bill-note" class="search-bar" style="min-height:60px;" placeholder="Write notes here... (Auto-saves)" oninput="autoSaveNote()"></textarea>
                
                <div class="media-actions">
                    <button class="media-btn" onclick="document.getElementById('cam-inp').click()"><i class="fas fa-camera"></i></button>
                    <button class="media-btn" onclick="openVideoRecorder()"><i class="fas fa-video"></i></button>
                    <button class="media-btn" id="btn-audio" onclick="toggleAudio()"><i class="fas fa-microphone"></i></button>
                    <button class="media-btn" onclick="document.getElementById('upl-inp').click()"><i class="fas fa-upload"></i></button>
                </div>
                <input type="file" id="upl-inp" hidden onchange="handleFileUpload(this, 'image')">
                <input type="file" id="cam-inp" accept="image/*" capture="environment" hidden onchange="handleFileUpload(this, 'image')">
                
                <div id="media-gallery" class="media-grid"></div>

                <div class="section-label">ITEMS</div>
                <div id="d-items"></div>
                <div class="section-label">PAYMENTS</div>
                <div id="d-history"></div>

                <div style="margin-top:15px; text-align:right; font-weight:bold; padding:10px; background:#111; border-radius:8px;">
                    <div style="color:#888;">Total: ‚Çπ<span id="d-total">0</span></div>
                    <div style="color:var(--green);">Received: ‚Çπ<span id="d-rec">0</span></div>
                    <div style="color:var(--red); font-size:24px;">Balance: ‚Çπ<span id="d-bal">0</span></div>
                </div>

                <div style="margin-top:15px; background:#222; padding:15px; border-radius:8px;">
                    <input type="number" id="pay-amt" class="inp-login" style="width:100%; box-sizing:border-box;" placeholder="Add Payment Amount">
                    <button class="btn-act" onclick="addPayment()">ADD PAYMENT (+)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="keys-modal" class="modal">
        <div class="modal-card">
            <h3 style="color:var(--gold); text-align:center;">SUPABASE KEYS</h3>
            <p style="font-size:11px; color:#888; margin-bottom:10px;">Keys will be stored on this device only.</p>
            <input type="text" id="k-url" class="inp-login" placeholder="Supabase URL">
            <input type="text" id="k-key" class="inp-login" placeholder="Anon Key">
            <button class="btn-act" onclick="saveKeys()">SAVE & REBOOT</button>
            <button class="btn-act" style="background:#333;color:#888;margin-top:5px;" onclick="closeModal('keys-modal')">CANCEL</button>
        </div>
    </div>

    <div id="stats-modal" class="modal"><div class="modal-card"><h3 style="color:var(--gold); text-align:center;">STATISTICS</h3><table class="stats-table"><tr><td>Total Bills</td><td class="stats-val" id="st-total">0</td></tr><tr><td>Sold / Delivered</td><td class="stats-val" style="color:var(--green)" id="st-sold">0</td></tr><tr><td>Cancelled</td><td class="stats-val" style="color:var(--red)" id="st-canc">0</td></tr><tr><td>Active Bill Amount</td><td class="stats-val" id="st-amt">‚Çπ0</td></tr><tr><td>Total Pending</td><td class="stats-val" style="color:var(--orange)" id="st-bal">‚Çπ0</td></tr></table><button class="btn-act" onclick="downloadStatsPDF()" style="margin-top:20px; background:var(--blue); color:white;">üìÑ DOWNLOAD REPORT (PDF)</button><button class="btn-act" style="margin-top:10px;" onclick="closeModal('stats-modal')">CLOSE</button></div></div>
    <div id="settings-modal" class="modal"><div class="modal-card"><h3 style="color:var(--gold); text-align:center;">SETTINGS</h3><div style="color:#888; font-size:12px; margin-bottom:15px;">Admin Actions</div><button class="btn-act btn-danger" onclick="deleteBook()">üóëÔ∏è DELETE BOOK & DATA</button><button class="btn-act" style="background:#333; margin-top:20px; color:#888;" onclick="closeModal('settings-modal')">CANCEL</button></div></div>
    <div id="video-recorder-modal" class="modal"><div style="position:relative; width:100%; height:100%; background:black; display:flex; flex-direction:column; justify-content:center; align-items:center;"><video id="camera-preview" autoplay playsinline muted></video><div style="position:absolute; bottom:50px; display:flex; gap:20px; align-items:center;"><button class="btn-act" style="background:#333; width:auto; padding:10px 20px;" onclick="closeVideoRecorder()">CANCEL</button><div id="rec-btn" class="rec-btn" onclick="toggleRecording()"></div></div><div id="rec-timer" style="position:absolute; top:50px; color:red; font-weight:900; font-size:24px; text-shadow:0 0 5px black; display:block;">00:00</div></div></div>
    <div id="upload-overlay"><div class="upload-text" id="upload-text">PROCESSING...</div><div class="progress-container"><div id="upload-bar" class="progress-bar"></div></div><div id="upload-details" class="upload-details">Please Wait</div></div>
    <div id="new-book-modal" class="modal"><div class="modal-card"><h3 style="color:var(--gold);">NEW BOOK</h3><input type="text" id="nb-name" class="inp-login" placeholder="Name"><input type="number" id="nb-start" class="inp-login" placeholder="Start"><input type="number" id="nb-end" class="inp-login" placeholder="End"><button class="btn-act" onclick="saveNewBook()">CREATE</button><button class="btn-act" style="background:#333;color:#888;margin-top:5px;" onclick="closeModal('new-book-modal')">CANCEL</button></div></div>
    <div id="edit-modal" class="modal"><div class="modal-card"><h3>EDIT AMT</h3><input type="number" id="edit-amt-inp" class="inp-login"><button class="btn-act" onclick="confirmEditAmount()">UPDATE</button><button class="btn-act" style="background:#333;margin-top:5px;" onclick="closeModal('edit-modal')">CLOSE</button></div></div>
    <div id="meas-modal" class="modal"><div class="modal-card" style="width:95%;max-width:500px;"><div id="meas-capture-area" class="meas-capture-box"><div class="meas-header-row"><div style="font-size:10px;color:#888;">ROYAL SHERWANI</div><div class="meas-bill-no" id="meas-bill-no">#000</div></div><div class="meas-cols"><div class="meas-col"><div class="meas-col-title">LOWER</div><div id="meas-left"></div></div><div class="meas-col" style="border-left:1px dashed #333;padding-left:10px;"><div class="meas-col-title">UPPER</div><div id="meas-right"></div></div></div></div><button class="btn-act" onclick="shareMeasurement()" style="margin-top:15px;background:var(--blue);">SHARE</button><button class="btn-act" style="margin-top:5px;background:#333;" onclick="closeModal('meas-modal')">CLOSE</button></div></div>
    <div id="lightbox"><button class="lightbox-close" onclick="document.getElementById('lightbox').style.display='none'">√ó</button><img id="lightbox-img"><video id="lightbox-video" controls></video></div>
    <div id="print-area"></div>

    <script>
        // --- LOGGING ---
        function log(msg, type='info') {
            const consoleBox = document.getElementById('debug-console');
            if(!consoleBox) return;
            const colorClass = type === 'error' ? 'log-err' : (type === 'success' ? 'log-ok' : 'log-warn');
            const time = new Date().toLocaleTimeString();
            consoleBox.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        // --- STORAGE KEYS HANDLING ---
        let SUPABASE_URL = localStorage.getItem('RS_SB_URL') || '';
        let SUPABASE_KEY = localStorage.getItem('RS_SB_KEY') || '';

        function requestKeyAccess() {
            const code = prompt("Enter Access Code:");
            if(code === "5563990") {
                document.getElementById('k-url').value = SUPABASE_URL;
                document.getElementById('k-key').value = SUPABASE_KEY;
                document.getElementById('keys-modal').style.display = 'flex';
            } else {
                alert("Unauthorized Access!");
            }
        }

        function saveKeys() {
            const u = document.getElementById('k-url').value.trim();
            const k = document.getElementById('k-key').value.trim();
            if(u && k) {
                localStorage.setItem('RS_SB_URL', u);
                localStorage.setItem('RS_SB_KEY', k);
                alert("Keys Saved Successfully. App will reload.");
                location.reload();
            } else {
                alert("Please fill both URL and Key fields.");
            }
        }

        // --- SUPABASE SETUP ---
        var billClient = null;
        var retryCount = 0;

        function initApp() {
            log("System Booting...");
            if(!SUPABASE_URL || !SUPABASE_KEY) {
                log("‚ö†Ô∏è Keys missing. Tap the key icon to configure.", 'error');
                return;
            }
            var checkInterval = setInterval(function() {
                if (typeof window.supabase !== 'undefined') {
                    clearInterval(checkInterval);
                    try {
                        billClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                            auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
                        });
                        log("‚úÖ Connected (Private Storage Mode)");
                        checkSavedLogin();
                        setInterval(checkConnection, 3000); 
                        checkConnection();
                    } catch (e) {
                        log("‚ùå Init Failed: " + e.message, 'error');
                    }
                } else {
                    retryCount++;
                    if (retryCount > 10) { clearInterval(checkInterval); log("‚ùå Library Failed.", 'error'); }
                }
            }, 500);
        }

        function checkSavedLogin() {
            try {
                const savedEmail = localStorage.getItem('royal_email');
                const savedPass = localStorage.getItem('royal_pass');
                if(savedEmail && savedPass) {
                    log("‚ôªÔ∏è Auto-Logging in...");
                    document.getElementById('email').value = savedEmail;
                    document.getElementById('password').value = savedPass;
                    handleLogin();
                } else {
                    log("‚ÑπÔ∏è Ready for Login.");
                }
            } catch(e) { log("Storage Access Error", 'warn'); }
        }

        window.onpopstate = function(event) {
            if (event.state && event.state.screen) { renderScreen(event.state.screen, event.state.data); } 
            else { if(document.getElementById('app-container').style.display === 'block'){ renderScreen('home'); } }
        };

        window.onload = initApp;

        async function handleLogin() { 
            const e=document.getElementById('email').value.trim();
            const p=document.getElementById('password').value.trim();
            if(!e || !p) { log("Enter Credentials", 'warn'); return; }
            if(!billClient) { log("System not initialized!", 'error'); return; }
            document.getElementById('login-loader').style.display='block';
            document.getElementById('loginBtn').disabled = true;
            log("Authenticating...");
            try {
                const { error } = await billClient.auth.signInWithPassword({email:e, password:p}); 
                document.getElementById('login-loader').style.display='none';
                document.getElementById('loginBtn').disabled = false;
                if(error) { log("‚ùå " + error.message, 'error'); } 
                else {
                    log("‚úÖ Success. Saving...");
                    localStorage.setItem('royal_email', e);
                    localStorage.setItem('royal_pass', p);
                    document.getElementById('login-screen').style.display='none'; 
                    document.getElementById('app-container').style.display='block'; 
                    loadBooks(); 
                    history.replaceState({screen: 'home'}, '', '');
                }
            } catch(err) {
                document.getElementById('login-loader').style.display='none';
                log("Crash: " + err.message, 'error');
            }
        }

        async function logout() { await billClient.auth.signOut(); location.reload(); }

        async function checkConnection() {
            if(!billClient) return;
            const pills = document.querySelectorAll('.global-status');
            const setStatus = (cls, txt) => { pills.forEach(p => { p.className = `status-badge-header global-status ${cls}`; p.querySelector('.status-text').innerText = txt; }); };
            if (navigator.onLine) {
                const { error } = await billClient.from('bill_books').select('id').limit(1).maybeSingle();
                if (!error) setStatus('online', 'ONLINE'); else setStatus('offline', 'DB ERROR');
            } else { setStatus('offline', 'NO NET'); }
        }

        const ADMIN_PASS = "2128722";
        const MEAS_LOWER = ['Kamar', 'Hips', 'Thai', 'Pindli', 'Mori', 'Length', 'Pent Length'];
        const MEAS_UPPER = ['Pagdi Size', 'Neck', 'Chest', 'Cross Back', 'Pet', 'Baju', 'Length', 'Upper Len', 'Inner Len', 'Baju Length', 'Shoulder'];
        let currentBookId = null, currentBookName = "", currentBill = null;
        let currentBookStart = 0, currentBookEnd = 0; 
        let allBills = [], filteredBills = [], billDeliveryTimes = {};
        let currentFilter = 'ALL';
        let mediaRecorder = null, audioChunks = [];
        let videoRecorder = null, videoChunks = [], videoStream = null;
        let recInterval = null, recStartTime = 0;
        let uploadInterval = null;

        function goToScreen(name, data) { history.pushState({screen: name, data: data}, '', ''); renderScreen(name, data); }
        function navigateBack() { history.back(); }
        function renderScreen(name, data) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('screen-'+name).classList.add('active-screen');
            if(name === 'list' && data) { document.getElementById('list-title').innerText = data.name; currentBookId = data.id; currentBookName = data.name; }
            if(name === 'detail' && data) { loadDetailView(data.billNo); }
        }

        async function loadBooks() {
            document.getElementById('books-loader').style.display='block';
            const { data: books } = await billClient.from('bill_books').select('*').eq('is_active', true);
            const { data: bills } = await billClient.from('bills').select('book_id, status');
            document.getElementById('books-loader').style.display='none';
            const cont = document.getElementById('books-container'); cont.innerHTML = '';
            if(books) books.forEach(b => {
                const bb = bills ? bills.filter(x => x.book_id === b.id) : [];
                const ready = bb.filter(x => x.status === 'READY').length;
                const sold = bb.filter(x => x.status === 'DELIVERED' || x.status === 'SOLD_OUT').length;
                cont.innerHTML += `<div class="book-tile" onclick="openBook(${b.id}, '${b.salesman_name}', ${b.start_serial}, ${b.end_serial})"><div><div class="bt-name">${b.salesman_name}</div><div style="font-size:11px; color:#888;">Series: ${b.start_serial} - ${b.end_serial}</div></div><div class="bt-stats"><span>Total: ${bb.length}</span> <span style="color:var(--green)">Ready: ${ready}</span> <span style="color:var(--gold)">Sold: ${sold}</span></div></div>`;
            });
        }

        function createNewBookPrompt() { if(prompt("Pass:")===ADMIN_PASS) document.getElementById('new-book-modal').style.display='flex'; }
        async function saveNewBook() { await billClient.from('bill_books').insert([{salesman_name:document.getElementById('nb-name').value, start_serial:document.getElementById('nb-start').value, end_serial:document.getElementById('nb-end').value, current_serial:document.getElementById('nb-start').value}]); closeModal('new-book-modal'); loadBooks(); }

        async function openBook(id, name, start, end) {
            currentBookStart = start; currentBookEnd = end;
            goToScreen('list', {name: name, id: id});
            const { data } = await billClient.from('bills').select('*').eq('book_id', id).order('bill_number', {ascending:false});
            const bNos = data.map(b => b.bill_number);
            const { data: items } = await billClient.from('items').select('bill_number, current_location, packet_id').in('bill_number', bNos);
            const { data: logs } = await billClient.from('logs').select('timestamp, action_type').ilike('action_type', 'SOLD_OUT_BILL_%');
            billDeliveryTimes = {};
            if(logs) logs.forEach(l => { const bn = l.action_type.split('SOLD_OUT_BILL_')[1]; if(bn) { const t=new Date(l.timestamp); if(!billDeliveryTimes[bn] || t>new Date(billDeliveryTimes[bn])) billDeliveryTimes[bn]=l.timestamp; } });
            allBills = data.map(b => {
                const myItems = items.filter(i => i.bill_number == b.bill_number);
                b.hasLinkedItems = myItems.length > 0;
                b.realStatus = calculateAggregatedStatus(b.status, myItems);
                if((b.realStatus.txt === 'SOLD' || b.status === 'DELIVERED') && billDeliveryTimes[b.bill_number]) b.deliveryTime = billDeliveryTimes[b.bill_number];
                return b;
            });
            applyFilters();
        }

        function calculateAggregatedStatus(dbStatus, items) {
            if(dbStatus === 'CANCELLED') return { txt: 'CANCELLED', cls: 'st-black' };
            if(!items || items.length === 0) {
                if(dbStatus === 'READY') return { txt: 'READY', cls: 'st-green' };
                if(dbStatus === 'DELIVERED') return { txt: 'SOLD', cls: 'st-dim' };
                return { txt: 'PENDING', cls: 'st-red' };
            }
            const locs = items.map(i => i.current_location);
            if(locs.some(l => l === 'SOLD_OUT')) return { txt: 'SOLD', cls: 'st-dim' };
            if(locs.some(l => l.includes('MASTER') || l.includes('EXTERNAL'))) return { txt: 'WORK', cls: 'st-orange' };
            const isAllPacked = locs.every(l => l.includes('PACKED')); 
            if(isAllPacked) { const pkts = [...new Set(items.map(i => i.packet_id).filter(Boolean))]; return { txt: 'READY', cls: 'st-green', packets: pkts.join(', ') }; }
            return { txt: 'PENDING', cls: 'st-red' };
        }

        function setFilter(type, btn) { currentFilter=type; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); applyFilters(); }
        function applyFilters() {
            const q = document.getElementById('search-inp').value.toLowerCase();
            filteredBills = allBills.filter(b => {
                const matchSearch = b.customer_name.toLowerCase().includes(q) || b.bill_number.toString().includes(q);
                let matchType = true;
                if(currentFilter === 'NO_ACTION') matchType = !b.hasLinkedItems && b.status !== 'CANCELLED';
                else if(currentFilter === 'READY') matchType = b.realStatus.txt === 'READY';
                else if(currentFilter === 'SOLD') matchType = b.realStatus.txt === 'SOLD';
                else if(currentFilter === 'CANCELLED') matchType = b.realStatus.txt === 'CANCELLED';
                return matchSearch && matchType;
            });
            renderBills();
        }

        function renderBills() {
            const cont = document.getElementById('bills-container'); cont.innerHTML = '';
            filteredBills.forEach(b => {
                const st = b.realStatus;
                let timeHtml = b.deliveryTime ? `<div class="del-time-badge">DELIVERED: ${new Date(b.deliveryTime).toLocaleDateString('en-GB')}</div>` : '';
                let pktHtml = (st.txt === 'READY' && st.packets) ? `<span class="pkt-badge-inline">PKT: ${st.packets}</span>` : '';
                cont.innerHTML += `<div class="bill-item ${st.cls}" onclick="openDetail('${b.bill_number}')"><div class="b-main"><div style="font-weight:900; color:var(--gold);">#${b.bill_number} ${pktHtml}</div><div>${b.customer_name}</div><div style="font-size:10px; color:#888;">${new Date(b.created_at).toLocaleDateString()}</div></div><div class="b-amt"><div>‚Çπ${b.total_amount}</div><div style="font-size:11px; color:${b.pending_amount>0?'var(--red)':'var(--green)'}">${b.pending_amount>0 ? 'BAL: '+b.pending_amount : 'PAID'}</div></div><div class="status-badge">${st.txt}</div>${timeHtml}</div>`;
            });
        }

        function openDetail(bNo) { if(!bNo) return alert("Error"); goToScreen('detail', {billNo: bNo}); }

        async function loadDetailView(bNo) {
            try {
                const { data: bill, error } = await billClient.from('bills').select('*').eq('bill_number', bNo).single();
                if(error) throw new Error(error.message);
                const { data: pay } = await billClient.from('payments').select('*').eq('bill_number', bNo).order('timestamp');
                const { data: items } = await billClient.from('items').select('id, current_location, packet_id').eq('bill_number', bNo);
                currentBill = bill;
                const st = calculateAggregatedStatus(bill.status, items);
                document.getElementById('d-no').innerText = "#"+bill.bill_number;
                document.getElementById('d-date').innerText = new Date(bill.created_at).toLocaleString();
                document.getElementById('d-name').innerText = bill.customer_name;
                document.getElementById('d-phone').innerText = bill.customer_phone;
                document.getElementById('d-del').innerText = bill.delivery_date || 'N/A';
                document.getElementById('bill-note').value = bill.bill_notes || '';
                document.getElementById('d-status').innerText = st.txt;
                const lc = document.getElementById('linked-container'); const ll = document.getElementById('linked-list'); ll.innerHTML='';
                if(items && items.length > 0) {
                    lc.classList.remove('hidden');
                    items.forEach(i => {
                        let p = i.packet_id ? ` <span style="color:var(--gold)">(${i.packet_id})</span>` : '';
                        ll.innerHTML += `<div class="linked-item-row"><span class="linked-id">${i.id}</span><span class="linked-st-txt">${i.current_location}${p}</span></div>`;
                    });
                } else lc.classList.add('hidden');
                const ic = document.getElementById('d-items'); ic.innerHTML='';
                let measData = null;
                if(bill.items_json) {
                    bill.items_json.forEach(i => { 
                        if(i.type === 'measurements') measData = i.data; 
                        else ic.innerHTML += `<div style="background:#222; padding:10px; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between; font-size:13px;"><span>${i.desc}</span><span>‚Çπ${i.price}</span></div>`; 
                    });
                }
                const mLeft = document.getElementById('meas-left'); const mRight = document.getElementById('meas-right'); mLeft.innerHTML = ''; mRight.innerHTML = '';
                document.getElementById('meas-bill-no').innerText = "#" + bill.bill_number;
                if(measData) {
                    MEAS_LOWER.forEach(k => { if(measData[k]) mLeft.innerHTML += `<div class="meas-pair"><span class="meas-k">${k}</span><span class="meas-v">${measData[k]}</span></div>`; });
                    MEAS_UPPER.forEach(k => { if(measData[k]) mRight.innerHTML += `<div class="meas-pair"><span class="meas-k">${k}</span><span class="meas-v">${measData[k]}</span></div>`; });
                } else mLeft.innerHTML = '<div style="color:#666; font-size:12px;">No Data</div>';
                const hc = document.getElementById('d-history'); hc.innerHTML='';
                if(pay) pay.forEach(p => { hc.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #444; font-size:12px;"><div>${p.mode}<br><span style="color:#666">${new Date(p.timestamp).toLocaleDateString()}</span></div><div style="color:var(--green); font-weight:bold;">+‚Çπ${p.amount}</div></div>`; });
                document.getElementById('d-total').innerText = bill.total_amount; 
                document.getElementById('d-rec').innerText = bill.received_amount; 
                document.getElementById('d-bal').innerText = bill.pending_amount;
                loadMedia();
            } catch(e) { alert("Error: " + e.message); }
        }

        function loadMedia() {
            const mg = document.getElementById('media-gallery'); mg.innerHTML = '';
            (currentBill.bill_media || []).forEach((m, i) => {
                let inner = '';
                if(m.type==='image') inner = `<img src="${m.url}" class="media-thumb" onclick="openLightbox('${m.url}','image')">`;
                else if(m.type==='video') inner = `<video src="${m.url}" class="media-thumb" onclick="openLightbox('${m.url}','video')"></video>`;
                else inner = `<div class="audio-player-ui"><button class="play-btn" onclick="togglePlay(this, '${m.url}')">‚ñ∂</button></div>`;
                mg.innerHTML += `<div class="media-box">${inner}<button class="btn-del-media" onclick="delMedia(${i})">√ó</button></div>`;
            });
        }
        
        let currentAudio = null;
        function togglePlay(btn, url) { if(currentAudio && currentAudio.src===url) { if(currentAudio.paused) { currentAudio.play(); btn.innerText='‚è∏'; } else { currentAudio.pause(); btn.innerText='‚ñ∂'; } } else { if(currentAudio) currentAudio.pause(); currentAudio = new Audio(url); currentAudio.play(); btn.innerText='‚è∏'; } }
        function openLightbox(u, t) { document.getElementById('lightbox').style.display='flex'; const i=document.getElementById('lightbox-img'), v=document.getElementById('lightbox-video'); i.style.display='none'; v.style.display='none'; if(t==='image') { i.src=u; i.style.display='block'; } else { v.src=u; v.style.display='block'; } }
        async function handleFileUpload(inp, type) { if(!inp.files[0]) return; await uploadFile(inp.files[0], type); }
        async function uploadFile(file, type) {
            const overlay = document.getElementById('upload-overlay');
            const bar = document.getElementById('upload-bar');
            overlay.style.display='flex'; bar.style.width = '10%';
            let p = 10; uploadInterval = setInterval(() => { p+=5; if(p>90) p=90; bar.style.width=p+'%'; }, 200);
            try {
                const ext = file.name.split('.').pop() || 'dat';
                const path = `bm_${currentBill.bill_number}_${Date.now()}.${ext}`;
                const { data, error } = await billClient.storage.from('bill-media').upload(path, file);
                clearInterval(uploadInterval); bar.style.width = '100%';
                if(error) throw error;
                const { data: urlData } = billClient.storage.from('bill-media').getPublicUrl(path);
                let m = currentBill.bill_media || [];
                m.push({url: urlData.publicUrl, type: type, path: path});
                await billClient.from('bills').update({bill_media: m}).eq('bill_number', currentBill.bill_number);
                loadDetailView(currentBill.bill_number);
                setTimeout(() => { overlay.style.display='none'; }, 500);
            } catch(e) { clearInterval(uploadInterval); overlay.style.display='none'; alert("Failed: " + e.message); }
        }
        async function delMedia(i) { if(confirm("Delete?")) { const m = currentBill.bill_media; await billClient.storage.from('bill-media').remove([m[i].path]); m.splice(i,1); await billClient.from('bills').update({bill_media:m}).eq('bill_number', currentBill.bill_number); loadDetailView(currentBill.bill_number); } }
        async function toggleAudio() { 
            const btn = document.getElementById('btn-audio'); 
            if(!mediaRecorder || mediaRecorder.state === "inactive") { 
                try {
                    const s = await navigator.mediaDevices.getUserMedia({audio:true}); 
                    mediaRecorder = new MediaRecorder(s); audioChunks=[]; 
                    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); 
                    mediaRecorder.onstop=async()=>{ const f=new File([new Blob(audioChunks)], "voice.webm"); await uploadFile(f, 'audio'); btn.classList.remove('recording'); }; 
                    mediaRecorder.start(); btn.classList.add('recording'); 
                } catch(e) { alert("Mic Error: "+e.message); }
            } else mediaRecorder.stop(); 
        }
        async function openVideoRecorder() { try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true }); document.getElementById('camera-preview').srcObject = videoStream; document.getElementById('video-recorder-modal').style.display='flex'; } catch(e) { alert("Camera Error: " + e.message); } }
        function closeVideoRecorder() { stopTimer(); if(videoStream) videoStream.getTracks().forEach(track => track.stop()); document.getElementById('video-recorder-modal').style.display='none'; }
        function startTimer() { recStartTime=Date.now(); recInterval=setInterval(()=>{ const d=Math.floor((Date.now()-recStartTime)/1000); document.getElementById('rec-timer').innerText = `${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`; }, 1000); }
        function stopTimer() { clearInterval(recInterval); document.getElementById('rec-timer').innerText="00:00"; }
        function toggleRecording() {
            const btn = document.getElementById('rec-btn'); const timer = document.getElementById('rec-timer');
            if (!videoRecorder || videoRecorder.state === 'inactive') {
                videoChunks = [];
                try { videoRecorder = new MediaRecorder(videoStream, { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 1500000 }); } catch (e) { videoRecorder = new MediaRecorder(videoStream, { videoBitsPerSecond: 1500000 }); }
                videoRecorder.ondataavailable = event => { if (event.data.size > 0) videoChunks.push(event.data); };
                videoRecorder.onstop = async () => {
                    timer.innerText = "SAVING..."; timer.style.color = "var(--red)";
                    const blob = new Blob(videoChunks, { type: 'video/webm' });
                    setTimeout(async () => { const file = new File([blob], "video_note.webm", { type: 'video/webm' }); closeVideoRecorder(); await uploadFile(file, 'video'); }, 1500);
                };
                videoRecorder.start(); startTimer(); btn.classList.add('recording');
            } else { stopTimer(); videoRecorder.stop(); btn.classList.remove('recording'); }
        }
        async function deleteBook() {
            if(!confirm("‚ö†Ô∏è DANGER: DELETE EVERYTHING?")) return;
            if(prompt("Type 'DELETE' to confirm:") !== "DELETE") return;
            const overlay = document.getElementById('upload-overlay');
            overlay.style.display='flex'; document.getElementById('upload-text').innerText = "DELETING...";
            try {
                const { data: bills } = await billClient.from('bills').select('bill_number, bill_media').eq('book_id', currentBookId);
                const billNos = bills.map(b => b.bill_number);
                let filesToDelete = [];
                bills.forEach(b => { if(b.bill_media) b.bill_media.forEach(m => { if(m.path) filesToDelete.push(m.path); }); });
                if(filesToDelete.length > 0) await billClient.storage.from('bill-media').remove(filesToDelete);
                await billClient.from('items').delete().in('bill_number', billNos);
                await billClient.from('payments').delete().in('bill_number', billNos);
                await billClient.from('bills').delete().eq('book_id', currentBookId);
                await billClient.from('bill_books').delete().eq('id', currentBookId);
                location.reload();
            } catch(e) { alert("Delete Failed: " + e.message); overlay.style.display='none'; }
        }
        function promptStats() {
            if(prompt("Admin Password:") !== ADMIN_PASS) return alert("Wrong");
            const activeBills = allBills.filter(b => b.status !== 'CANCELLED');
            document.getElementById('st-total').innerText = allBills.length;
            document.getElementById('st-sold').innerText = allBills.filter(b => b.realStatus.txt === 'SOLD').length;
            document.getElementById('st-canc').innerText = allBills.filter(b => b.status === 'CANCELLED').length;
            document.getElementById('st-amt').innerText = "‚Çπ" + activeBills.reduce((acc, b) => acc + (parseFloat(b.total_amount) || 0), 0);
            document.getElementById('st-bal').innerText = "‚Çπ" + activeBills.reduce((acc, b) => acc + (parseFloat(b.pending_amount) || 0), 0);
            document.getElementById('stats-modal').style.display='flex';
        }
        function downloadStatsPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFillColor(20, 20, 20); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(197, 160, 89); doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.text("ROYAL SHERWANI", 105, 15, null, null, "center");
            doc.setTextColor(255, 255, 255); doc.setFontSize(12); doc.text(`Salesman: ${currentBookName} (${currentBookStart} - ${currentBookEnd})`, 105, 25, null, null, "center");
            const sortedBills = allBills.slice().sort((a,b) => a.bill_number - b.bill_number);
            let totAmt = 0; let totRec = 0; let totBal = 0;
            const tableRows = sortedBills.map(b => {
                const isCancelled = b.status === 'CANCELLED';
                const rowColor = isCancelled ? [255, 0, 0] : [0, 0, 0];
                if(!isCancelled) { totAmt += (parseFloat(b.total_amount) || 0); totRec += (parseFloat(b.received_amount) || 0); totBal += (parseFloat(b.pending_amount) || 0); }
                return [ { content: b.bill_number, styles: { textColor: rowColor } }, { content: b.customer_name, styles: { textColor: rowColor } }, { content: isCancelled ? "CANCELLED" : (b.pending_amount <= 0 ? "CLEARED" : "PENDING"), styles: { textColor: rowColor, fontStyle: 'bold' } }, { content: b.total_amount, styles: { textColor: rowColor } }, { content: b.received_amount, styles: { textColor: rowColor } }, { content: b.pending_amount, styles: { textColor: isCancelled ? [255,0,0] : [200, 50, 50], fontStyle: 'bold' } } ];
            });
            doc.autoTable({ head: [["Bill #", "Customer", "Status", "Total", "Recvd", "Bal"]], body: tableRows, startY: 45, theme: 'grid', headStyles: { fillColor: [20, 20, 20], textColor: [197, 160, 89] } });
            let finalY = doc.lastAutoTable.finalY + 10;
            if (finalY > 250) { doc.addPage(); finalY = 20; }
            doc.setDrawColor(0); doc.setFillColor(245, 245, 245); doc.rect(14, finalY, 120, 35, 'FD');
            doc.setTextColor(0); doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.text("SUMMARY (Active Bills Only)", 20, finalY + 8);
            doc.setFont("helvetica", "normal"); doc.setFontSize(10);
            doc.text(`Total Active Amount:`, 20, finalY + 16); doc.text(`Total Received:`, 20, finalY + 22); doc.text(`Total Pending:`, 20, finalY + 28);
            doc.setFont("helvetica", "bold"); doc.text(`Rs. ${totAmt}`, 80, finalY + 16);
            doc.setTextColor(0, 150, 0); doc.text(`Rs. ${totRec}`, 80, finalY + 22);
            doc.setTextColor(200, 0, 0); doc.text(`Rs. ${totBal}`, 80, finalY + 28);
            doc.save(`Report_${currentBookName}.pdf`);
        }
        function promptSettings() { if(prompt("Admin Password:") !== ADMIN_PASS) return alert("Wrong"); document.getElementById('settings-modal').style.display='flex'; }
        function showMeas() { document.getElementById('meas-modal').style.display='flex'; } 
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function autoSaveNote() { const s=document.getElementById('note-status'); s.innerText="Saving..."; clearTimeout(window.nT); window.nT=setTimeout(()=>{ billClient.from('bills').update({bill_notes:document.getElementById('bill-note').value}).eq('bill_number', currentBill.bill_number).then(()=>{s.innerText="Saved ‚úÖ"; setTimeout(()=>s.innerText="",2000);}); }, 1000); }
        function addPayment() { const a=parseFloat(document.getElementById('pay-amt').value); if(a) billClient.from('payments').insert([{bill_number:currentBill.bill_number, amount:a, mode:'CASH', type:'BALANCE'}]).then(()=>billClient.from('bills').update({received_amount:currentBill.received_amount+a, pending_amount:currentBill.pending_amount-a}).eq('bill_number',currentBill.bill_number).then(()=>loadDetailView(currentBill.bill_number))); }
        function shareMeasurement() { html2canvas(document.getElementById('meas-capture-area')).then(c => c.toBlob(b => navigator.share({files:[new File([b],'size.png',{type:'image/png'})]}))); }
        function toggleAdmin() { const m=document.querySelector('.admin-menu'); m.style.display=m.style.display==='block'?'none':'block'; }
        function adminAction(t) { toggleAdmin(); if(prompt("Pass")===ADMIN_PASS) { if(t==='amt') document.getElementById('edit-modal').style.display='flex'; if(t==='cancel') billClient.from('bills').update({status:'CANCELLED'}).eq('bill_number',currentBill.bill_number).then(()=>loadDetailView(currentBill.bill_number)); } }
        function confirmEditAmount() { const n=parseFloat(document.getElementById('edit-amt-inp').value); if(n) billClient.from('bills').update({total_amount:n, pending_amount:currentBill.pending_amount+(n-currentBill.total_amount)}).eq('bill_number',currentBill.bill_number).then(()=>{ closeModal('edit-modal'); loadDetailView(currentBill.bill_number); }); }
    </script>
</body>
</html>
